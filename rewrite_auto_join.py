from pathlib import Path

path = Path("reklama_telega/monitor.py")
text = path.read_text(encoding="utf-8")
start = text.index("async def _auto_join_targets")
end = text.index("async def scan_history", start)
new_block = """async def _auto_join_targets(\n    client: TelegramClient,\n    targets: Sequence[TargetDialog],\n    on_status: StatusCallback,\n    on_error: ErrorCallback,\n) -> None:\n    joined_ids: set[int] = set()\n    try:\n        dialogs = await client.get_dialogs(limit=None)\n        for dialog in dialogs:\n            entity = getattr(dialog, \"entity\", None)\n            dialog_id = getattr(entity, \"id\", None)\n            if dialog_id is not None:\n                joined_ids.add(dialog_id)\n    except Exception as exc:  # pragma: no cover\n        log.warning(\"Не удалось получить список диалогов: %s\", exc)\n\n    for target in targets:\n        entity = target.entity\n        if not isinstance(entity, Channel):\n            continue\n        if target.id in joined_ids:\n            await _dispatch_status(on_status, f\"Уже подписаны на {target.title}, пропускаю.\")\n            continue\n        try:\n            await client(functions.channels.JoinChannelRequest(entity))\n            await _dispatch_status(on_status, f\"Подписались на {target.title}\")\n            joined_ids.add(target.id)\n            await asyncio.sleep(1.0)\n        except errors.UserAlreadyParticipantError:\n            await _dispatch_status(on_status, f\"Уже подписаны на {target.title}, пропускаю.\")\n            joined_ids.add(target.id)\n        except errors.FloodWaitError as exc:  # pragma: no cover\n            seconds = getattr(exc, \"seconds\", None)\n            message = (\n                f\"Flood wait {seconds} с при подписке на {target.title}, авто-подписка остановлена.\"\n                if seconds\n                else f\"Flood wait при подписке на {target.title}, авто-подписка остановлена.\"\n            )\n            await _dispatch_error(on_error, message)\n            break\n        except Exception as exc:  # pragma: no cover\n            log.warning(\"Не удалось подписаться на %s: %s\", target.title, exc)\n            await _dispatch_error(on_error, f\"Не удалось подписаться на {target.title}: {exc}\")\n"""\n
path.write_text(text[:start] + new_block + text[end:], encoding="utf-8")
